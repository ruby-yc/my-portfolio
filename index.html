<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YuChen Dong (Ruby)</title>
  <link rel="stylesheet" href="style.css" />
  <style>


    /* 防止 body 對整體滾動有干擾 */
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
  </style>
</head>
<body>

  <!--  頁首 -->
  <div class="header" id="header">
    <img src="images/background_white.png" alt="background image">
    <div class="header-text" id="headerText">
      <h2 class="header-title">YuChen (Ruby) Dong</h2>
      <h3 class="header-subtitle">
        Aspiring Software Engineer exploring where aesthetics meet algorithms.
        
      </h3>
    </div>
  </div>

  <!--  導覽列 -->
  <div class="tabs-wrapper" id="tabsWrapper">
    <div class="tabs">
      <div class="tab active" onclick="loadPage('intro.html', this)">Intro</div>
      <div class="tab" onclick="loadPage('project.html', this)">Projects</div>
      <div class="tab" onclick="loadPage('skill.html', this)">Skills</div>
      <div class="tab" onclick="loadPage('resume.html', this)">Resume</div>
      <div class="tab" onclick="loadPage('other.html', this)">Other</div>
      <div class="tab" onclick="loadPage('contact.html', this)">Contact</div>
    </div>
  </div>

  <!--  iframe 內容區 -->
  <iframe id="contentFrame" src="intro.html" scrolling="no"></iframe>

<script>

if ('scrollRestoration' in history) {
    try { history.scrollRestoration = 'manual'; } catch (e) {}
}
function forceScrollTop() {
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    setTimeout(() => window.scrollTo(0, 0), 100);
    setTimeout(() => window.scrollTo(0, 0), 400);
}
window.addEventListener('load', forceScrollTop);
window.addEventListener('pageshow', () => forceScrollTop());
if (location.hash) {
    history.replaceState(null, '', location.pathname + location.search);
    forceScrollTop();
}

const header = document.getElementById('header');
const tabsWrapper = document.getElementById('tabsWrapper');
const iframe = document.getElementById('contentFrame');
let pollIntervalId = null;
let lastHeight = 0;

window.addEventListener('scroll', () => {
    const scrollY = window.scrollY;
    const opacity = Math.max(0, 1 - scrollY / 150);
    header.style.opacity = opacity;
    tabsWrapper.style.opacity = opacity;
});

function loadPage(pageUrl, tabElement) {
    forceScrollTop();

    if (pollIntervalId) clearInterval(pollIntervalId);

    // 重置為初始狀態
    iframe.style.height = '300px';
    lastHeight = 0;
    pollingStopped = false;  // 重置輪詢標誌

    iframe.src = pageUrl;
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    tabElement.classList.add('active');

    iframe.onload = () => {
        // 讓子頁面完全加載
        setTimeout(() => {
            iframe.contentWindow?.postMessage({ type: 'getHeight' }, '*');
        }, 100);
    };

    // 一次性輪詢，而不是持續輪詢
    let pollCount = 0;
    const MAX_POLLS = 15;
    pollIntervalId = setInterval(() => {
        iframe.contentWindow?.postMessage({ type: 'getHeight' }, '*');
        if (++pollCount >= MAX_POLLS) {
            clearInterval(pollIntervalId);
            pollingStopped = true;  // 標記輪詢已停止
            console.log('stop, final height:', lastHeight);
        }
    }, 150);
}

let pollingStopped = false;

function setIframeHeight(height) {
    // 輪詢停止後不再更新高度
    if (pollingStopped && lastHeight > 0) {
        console.log('stop, ignore new height change');
        return;
    }
    
    if (height <= 0) return;
    
    const newHeight = height + 20;
    
    if (newHeight === lastHeight) return;
    
    lastHeight = newHeight;
    iframe.style.height = newHeight + 'px';
    console.log('iframe new height set', newHeight);
}

window.addEventListener('message', (event) => {
    if (event.data?.type === 'setHeight') {
        const height = event.data.height;
        setIframeHeight(height);
    }
});
</script>

</body>
</html>
